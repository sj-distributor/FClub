FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build-env

WORKDIR /app
EXPOSE 80
EXPOSE 443

COPY ./src/FClub.Api ./build/FClub.Api
COPY ./src/FClub.Core ./build/FClub.Core
COPY ./src/FClub.Messages ./build/FClub.Messages
COPY ./NuGet.Config ./build

RUN dotnet publish build/FClub.Api -c Release -o out

FROM mcr.microsoft.com/dotnet/aspnet:7.0

USER root

RUN apt-get update && \
    apt-get install -y \
    bzip2 \
    make \
    gcc \
    yasm \
    libopencore-amrnb-dev \
    libopencore-amrwb-dev \
    wget \
    xz-utils \
    && rm -rf /var/lib/apt/lists/*

# ffmpeg
RUN apt-get update && apt-get install -y bzip2 make gcc yasm libopencore-amrnb-dev libopencore-amrwb-dev wget xz-utils

RUN wget https://ffmpeg.org/releases/ffmpeg-7.0.tar.xz && \
    tar -xJf ffmpeg-7.0.tar.xz && \
    cd ffmpeg-7.0 && \
    ./configure --enable-gpl --enable-libopencore-amrnb --enable-libopencore-amrwb --prefix=/usr/local/ffmpeg --enable-version3 && \
    make -j$(nproc) && \
    make install && \
    ln -s /usr/local/ffmpeg/bin/ffmpeg /usr/local/bin/ && \
    cd .. && \
    rm -rf ffmpeg-7.0 ffmpeg-7.0.tar.xz

RUN ls -la /usr/local/ffmpeg/bin/ffmpeg

WORKDIR /app
COPY --from=build-env /app/out .
ENV PATH="/usr/local/ffmpeg/bin:${PATH}"
ENTRYPOINT ["dotnet", "FClub.Api.dll"]